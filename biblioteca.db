PRAGMA foreign_keys = ON;

------Tables-----

CREATE TABLE categoria (
    id_categoria INT NOT NULL PRIMARY KEY,
    nome TEXT NOT NULL
);

CREATE TABLE livro(
    id_livro INT NOT NULL PRIMARY KEY,
    titulo TEXT NOT NULL,
    autor TEXT, 
    quantidade INT,
    id_categoria INT,
    FOREIGN KEY (id_categoria) REFERENCES categoria(id_categoria)
);

CREATE TABLE leitor(
    id_leitor INT NOT NULL PRIMARY KEY,
    nome TEXT NOT NULL,
    email TEXT NOT NULL
);


CREATE TABLE funcionario(
    id_funcionario INT NOT NULL PRIMARY KEY,
    nome TEXT NOT NULL,
    cargo TEXT
);

CREATE TABLE emprestimo(
    id_emprestimo INT NOT NULL PRIMARY KEY,
    data_emprestimo DATE,
    data_prevista DATE,
    id_livro INT,
    id_leitor INT,
    id_funcionario INT,
    FOREIGN KEY (id_livro) REFERENCES livro(id_livro),
    FOREIGN KEY (id_leitor) REFERENCES leitor(id_leitor),
    FOREIGN KEY (id_funcionario) REFERENCES funcionario(id_funcionario)
);

CREATE TABLE devolucao(
    id_devolucao INT NOT NULL PRIMARY KEY,
    data_devolucao DATE,
    id_emprestimo INT,
    FOREIGN KEY (id_emprestimo) REFERENCES emprestimo(id_emprestimo)
);



--------Insert------

-- Inserindo categorias
INSERT INTO categoria (id_categoria, nome) VALUES
(1, 'Ficção'),
(2, 'Tecnologia'),
(3, 'História');

-- Inserindo livros
INSERT INTO livro (id_livro, titulo, autor, quantidade, id_categoria) VALUES
(1, 'Clean Code', 'Robert C. Martin', 4, 2),
(2, '1984', 'George Orwell', 6, 1),
(3, 'Sapiens', 'Yuval Noah Harari', 3, 3);

-- Inserindo leitores
INSERT INTO leitor (id_leitor, nome, email) VALUES
(1, 'João Silva', 'joao@gmail.com'),
(2, 'Marina Costa', 'marina@gmail.com'),
(3, 'Carlos Dias', 'carlos@gmail.com');

-- Inserindo funcionários
INSERT INTO funcionario (id_funcionario, nome, cargo) VALUES
(1, 'Ana Paula', 'Atendente'),
(2, 'Roberto Lima', 'Gerente');

-- Inserindo empréstimos
INSERT INTO emprestimo (id_emprestimo, data_emprestimo, data_prevista, id_livro, id_leitor, id_funcionario) VALUES
(1, '2025-02-01', '2025-02-10', 1, 1, 1),
(2, '2025-02-03', '2025-02-12', 2, 2, 2);

-- Inserindo devoluções
INSERT INTO devolucao (id_devolucao, data_devolucao, id_emprestimo) VALUES
(1, '2025-02-09', 1);


--------Select------

-- 1. Listar todos os livros ordenados por quantidade
SELECT * FROM livro
ORDER BY quantidade DESC;

-- 2. Buscar leitores cujo nome contém "a"
SELECT * FROM leitor
WHERE nome LIKE '%a%';

-- 3. Juntar empréstimos com nome do leitor e título do livro
SELECT e.id_emprestimo, l.nome AS leitor, lv.titulo AS livro, e.data_emprestimo
FROM emprestimo e
JOIN leitor l ON e.id_leitor = l.id_leitor
JOIN livro lv ON e.id_livro = lv.id_livro;

-- 4. Listar apenas 2 funcionários
SELECT nome, cargo
FROM funcionario
LIMIT 2;

-- 5. Mostrar livros com suas categorias
SELECT lv.titulo, lv.autor, c.nome AS categoria
FROM livro lv
JOIN categoria c ON lv.id_categoria = c.id_categoria;



-----Update-----

-- 1. Atualizar quantidade de um livro
UPDATE livro
SET quantidade = quantidade + 1
WHERE id_livro = 1;

-- 2. Atualizar cargo do funcionário
UPDATE funcionario
SET cargo = 'Supervisor'
WHERE id_funcionario = 1;

-- 3. Atualizar email do leitor
UPDATE leitor
SET email = 'novoemail@gmail.com'
WHERE id_leitor = 3;



------DELETE------

-- 1. Remover um leitor específico
DELETE FROM leitor
WHERE id_leitor = 3;

-- 2. Remover livros com quantidade 0 (exemplo)
DELETE FROM livro
WHERE quantidade = 0;

-- 3. Remover devoluções antigas
DELETE FROM devolucao
WHERE data_devolucao < '2025-01-01';

